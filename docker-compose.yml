# Wildbox Security Suite - Integration Testing Orchestrator
# Coordinates all services with shared networking for end-to-end testing
#
# ðŸš¨ SECURITY WARNING: This configuration uses default values for testing!
# ðŸ“‹ BEFORE PRODUCTION: 
#   1. Copy .env.example to .env
#   2. Generate secure random values for all secrets
#   3. Change all default passwords
#   4. Review SECURITY.md for complete security checklist
#
# See SECURITY.md for complete production security requirements

networks:
  wildbox:
    driver: bridge

services:
  # Identity Service (Authentication & Authorization)
  identity:
    build:
      context: ./open-security-identity
      dockerfile: Dockerfile
    container_name: open-security-identity
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - CREATE_INITIAL_ADMIN=${CREATE_INITIAL_ADMIN:-true}
      - INITIAL_ADMIN_EMAIL=${INITIAL_ADMIN_EMAIL}
      - INITIAL_ADMIN_PASSWORD=${INITIAL_ADMIN_PASSWORD}
    depends_on:
      - postgres
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Service (Security Tools Platform)
  api:
    build:
      context: ./open-security-tools
      dockerfile: Dockerfile
    container_name: open-security-tools
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - API_KEY=${API_KEY}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      - REDIS_URL=redis://wildbox-redis:6379/2
      # Increased rate limits for AI agent service
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-500}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60}
    depends_on:
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Celery Worker for Async Tool Execution
  tools-worker:
    build:
      context: ./open-security-tools
      dockerfile: Dockerfile
    container_name: open-security-tools-worker
    restart: unless-stopped
    command: celery -A app.celery_app worker --loglevel=info --concurrency=4 --max-tasks-per-child=50 -I app.tasks
    environment:
      - API_KEY=${API_KEY}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=DEBUG
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - REDIS_URL=redis://wildbox-redis:6379/2
    depends_on:
      - wildbox-redis
      - api
    networks:
      - wildbox
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.celery_app inspect ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Flower - Celery Monitoring UI (optional, for development)
  tools-flower:
    build:
      context: ./open-security-tools
      dockerfile: Dockerfile
    container_name: open-security-tools-flower
    restart: unless-stopped
    command: celery -A app.celery_app flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - REDIS_URL=redis://wildbox-redis:6379/2
    depends_on:
      - wildbox-redis
      - tools-worker
    networks:
      - wildbox

  # Data Service (Threat Intelligence & IOCs)
  data:
    build:
      context: ./open-security-data
      dockerfile: Dockerfile
    container_name: open-security-data
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - DATABASE_URL=${DATA_DATABASE_URL}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
    depends_on:
      - postgres
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Data Scheduler (Threat Intelligence Collection Tasks)
  data-scheduler:
    build:
      context: ./open-security-data
      dockerfile: Dockerfile
    container_name: open-security-data-scheduler
    restart: unless-stopped
    command: python -m app.scheduler.main
    environment:
      - DATABASE_URL=${DATA_DATABASE_URL}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - postgres
      - data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'python -m app.scheduler.main' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Gateway (Request Routing & Security)
  gateway:
    build:
      context: ./open-security-gateway
      dockerfile: Dockerfile
    container_name: open-security-gateway
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./open-security-gateway/nginx:/etc/nginx:ro
      - ./open-security-gateway/logs:/var/log/nginx
      - ./open-security-gateway/ssl:/etc/ssl/wildbox:ro
    environment:
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
      - WILDBOX_ENV=${WILDBOX_ENV:-development}
      - GATEWAY_LOG_LEVEL=${GATEWAY_LOG_LEVEL:-info}
      - IDENTITY_SERVICE_URL=${IDENTITY_SERVICE_URL:-http://open-security-identity:8001}
      - GATEWAY_INTERNAL_SECRET=${GATEWAY_INTERNAL_SECRET}
      - AUTH_CACHE_TTL=${AUTH_CACHE_TTL:-300}
      - GATEWAY_DEBUG=${GATEWAY_DEBUG:-false}
    networks:
      - wildbox
    depends_on:
      - wildbox-redis
      - identity
      - guardian
      - responder
      - agents
      - automations
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Dashboard (Frontend)
  dashboard:
    build:
      context: ./open-security-dashboard
      dockerfile: Dockerfile.dev
    container_name: open-security-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./open-security-dashboard:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_DEBUG=${NEXT_PUBLIC_DEBUG:-false}
      - NEXT_PUBLIC_USE_GATEWAY=true
      - NEXT_PUBLIC_GATEWAY_URL=http://localhost:80
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:80/api/v1/tools
      - NEXT_PUBLIC_IDENTITY_API_URL=http://localhost:80/api/v1/identity
      - NEXT_PUBLIC_DATA_API_URL=http://localhost:80/api/v1/data
      - NEXT_PUBLIC_GUARDIAN_API_URL=http://localhost:80/api/v1/guardian
      # EXCLUDED FROM v1.0: - NEXT_PUBLIC_SENSOR_API_URL=http://localhost:80/api/v1/sensor
      - NEXT_PUBLIC_RESPONDER_API_URL=http://localhost:80/api/v1/responder
      - NEXT_PUBLIC_AGENTS_API_URL=http://localhost:80/api/v1/agents
      # EXCLUDED FROM v1.0: - NEXT_PUBLIC_CSPM_API_URL=http://localhost:80/api/v1/cspm
      # Internal URLs for server-side requests within Docker network
      - INTERNAL_GATEWAY_URL=http://open-security-gateway:80
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=http://localhost:3000
    networks:
      wildbox:
        aliases:
          - dashboard
    depends_on:
      - gateway
      - identity

  # PostgreSQL Database (Identity Service)
  postgres:
    image: postgres:15
    container_name: wildbox-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-identity}
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 256M
    # SECURITY: PostgreSQL not exposed to host. Access via Docker network only.
    # Uncomment for local development if needed:
    # ports:
    #   - "127.0.0.1:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Shared Redis Cache (Consolidated for all services)
  wildbox-redis:
    image: redis:7-alpine
    container_name: wildbox-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru --databases 16
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 128M
    volumes:
      - wildbox_redis_data:/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3


  # Guardian Service (Security Monitoring)
  guardian:
    build:
      context: ./open-security-guardian
      dockerfile: Dockerfile
    container_name: open-security-guardian
    restart: unless-stopped
    ports:
      - "8013:8013"
    environment:
      - DATABASE_URL=${GUARDIAN_DATABASE_URL}
      - REDIS_URL=${GUARDIAN_REDIS_URL:-redis://wildbox-redis:6379/1}
      - CELERY_BROKER_URL=${GUARDIAN_CELERY_BROKER_URL:-redis://wildbox-redis:6379/1}
      - CELERY_RESULT_BACKEND=${GUARDIAN_CELERY_RESULT_BACKEND:-redis://wildbox-redis:6379/1}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/guardian.log
      - ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,open-security-guardian
    volumes:
      - guardian_logs:/app/logs
    depends_on:
      - postgres
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8013/health"]
      interval: 30s
      timeout: 10s
      retries: 3



  # Responder Service (Incident Response)
  responder:
    build:
      context: ./open-security-responder
      dockerfile: Dockerfile
    container_name: open-security-responder
    restart: unless-stopped
    ports:
      - "8018:8018"
    environment:
      - DATABASE_URL=${RESPONDER_DATABASE_URL}
      - REDIS_URL=${RESPONDER_REDIS_URL:-redis://wildbox-redis:6379/2}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - postgres
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8018/health"]
      interval: 30s
      timeout: 10s
      retries: 3



  # ============================================================================
  # CSPM Service (Cloud Security Posture Management)
  # ============================================================================
  cspm:
    build:
      context: ./open-security-cspm
      dockerfile: Dockerfile
    container_name: open-security-cspm
    restart: unless-stopped
    ports:
      - "8019:8019"
    environment:
      - REDIS_URL=${CSPM_REDIS_URL:-redis://wildbox-redis:6379/3}
      - CELERY_BROKER_URL=${CSPM_CELERY_BROKER_URL:-redis://wildbox-redis:6379/3}
      - CELERY_RESULT_BACKEND=${CSMP_CELERY_RESULT_BACKEND:-redis://wildbox-redis:6379/3}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8019/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CSPM Celery Worker (Background Tasks)
  # cspm-worker:
  #   build:
  #     context: ./open-security-cspm
  #     dockerfile: Dockerfile
  #   container_name: open-security-cspm-worker
  #   restart: unless-stopped
  #   command: celery -A app.worker worker --loglevel=info --concurrency=4
  #   environment:
  #     - REDIS_URL=redis://wildbox-redis:6379/3
  #     - CELERY_BROKER_URL=redis://wildbox-redis:6379/3
  #     - CELERY_RESULT_BACKEND=redis://wildbox-redis:6379/3
  #     - LOG_LEVEL=INFO
  #   depends_on:
  #     - wildbox-redis
  #   networks:
  #     - wildbox

  # Ollama Service (Local LLM API)
  # Provides OpenAI-compatible API for AI agents using Qwen2.5:0.5b
  # Much lighter than vLLM (~2GB image + ~300MB model)
  llm:
    image: ollama/ollama:0.4.7
    container_name: wildbox-llm
    restart: unless-stopped
    # SECURITY: Ollama only accessible within Docker network, not exposed to host
    environment:
      - OLLAMA_ORIGINS=http://open-security-agents:8006
    volumes:
      - llm_cache:/root/.ollama
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    # Uncomment for GPU support (requires nvidia-docker)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Agents Service (Security Agents)
  agents:
    build:
      context: ./open-security-agents
      dockerfile: Dockerfile
    container_name: open-security-agents
    restart: unless-stopped
    ports:
      - "8006:8006"
    environment:
      # Local LLM configuration (Ollama with OpenAI compatibility)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-http://llm:11434/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-qwen2.5:0.5b}
      - WILDBOX_API_URL=${WILDBOX_API_URL:-http://api:8000}  # Tools service endpoint
      # Authentication for tools service (must match API_KEY in tools service)
      - INTERNAL_API_KEY=${API_KEY}
      - REDIS_URL=${AGENTS_REDIS_URL:-redis://wildbox-redis:6379/4}
      - CELERY_BROKER_URL=${AGENTS_CELERY_BROKER_URL:-redis://wildbox-redis:6379/4}
      - CELERY_RESULT_BACKEND=${AGENTS_CELERY_RESULT_BACKEND:-redis://wildbox-redis:6379/4}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - wildbox-redis
      - api
      - llm
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # NOTE: Agents worker is now started by the entrypoint.sh script
  # in the main agents container, so no separate worker container needed.


  # ============================================================================
  # Sensor Service (System Monitoring)
  # ============================================================================
  sensor:
    build:
      context: ./open-security-sensor
      dockerfile: Dockerfile
    container_name: open-security-sensor
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      - SENSOR_LOGGING_LEVEL=${SENSOR_LOGGING_LEVEL:-INFO}
      - PYTHONPATH=/app
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./open-security-sensor/config.yaml.example:/etc/security-sensor/config.yaml:ro
      - sensor_logs:/var/log/security-sensor
      - sensor_data:/var/lib/security-sensor
      # Host monitoring (limited to safe read-only paths)
      - /proc/stat:/host/proc/stat:ro
      - /proc/meminfo:/host/proc/meminfo:ro
      - /proc/loadavg:/host/proc/loadavg:ro
      - /sys/class/net:/host/sys/class/net:ro
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Automations Service (n8n workflow automation)
  automations:
    image: n8nio/n8n:1.74.0
    container_name: open-security-automations
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - GENERIC_TIMEZONE=UTC
      - N8N_LOG_LEVEL=info
      - WEBHOOK_URL=http://localhost:5678
      - DB_TYPE=sqlite
      - DB_SQLITE_DATABASE=/home/node/.n8n/database.sqlite
      - N8N_SECURE_COOKIE=true
      - N8N_METRICS=true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    volumes:
      - ./open-security-automations/n8n-data:/home/node/.n8n
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
  wildbox_redis_data:
  guardian_logs:
  llm_cache:
  # Service-specific volumes
  sensor_logs:
  sensor_data:

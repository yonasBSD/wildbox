# HAProxy configuration for Blue/Green deployments
#
# Features:
# - Health check-based routing
# - Stats dashboard on :8404
# - Graceful draining of old environment
# - SSL termination

global
    log stdout format raw local0
    maxconn 4096
    daemon
    # Hide HAProxy version in error pages
    tune.h2.max-concurrent-streams 100

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  30000ms
    timeout server  30000ms
    
    # Health check defaults
    option  httpchk GET /health HTTP/1.1
    http-check expect status 200

# Stats dashboard (localhost only, requires auth)
listen stats
    bind 127.0.0.1:8404
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats hide-version
    stats auth admin:${HAPROXY_STATS_PASSWORD}

# Frontend (all incoming traffic)
frontend http_front
    bind *:80

    # Security headers
    http-response del-header Server
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"

    # Rate limiting (100 req/10s per IP)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    default_backend wildbox_services

# Backend (service routing)
backend wildbox_services
    balance roundrobin
    
    # Identity service (active: blue)
    server identity-blue identity-blue:8001 check inter 2000 rise 2 fall 3
    # server identity-green identity-green:8001 check inter 2000 rise 2 fall 3 backup
    
    # Guardian service (active: blue)
    server guardian-blue guardian-blue:8013 check inter 2000 rise 2 fall 3
    # server guardian-green guardian-green:8013 check inter 2000 rise 2 fall 3 backup
    
    # Data service (active: blue)
    server data-blue data-blue:8002 check inter 2000 rise 2 fall 3
    # server data-green data-green:8002 check inter 2000 rise 2 fall 3 backup
    
    # Tools service (active: blue)
    server tools-blue tools-blue:8000 check inter 2000 rise 2 fall 3
    # server tools-green tools-green:8000 check inter 2000 rise 2 fall 3 backup
    
    # Agents service (active: blue)
    server agents-blue agents-blue:8006 check inter 2000 rise 2 fall 3
    # server agents-green agents-green:8006 check inter 2000 rise 2 fall 3 backup

# Health check endpoints
backend identity_health
    server identity-blue identity-blue:8001 check
    server identity-green identity-green:8001 check backup

backend guardian_health
    server guardian-blue guardian-blue:8013 check
    server guardian-green guardian-green:8013 check backup

# Common proxy parameters for Wildbox services

proxy_http_version 1.1;
proxy_set_header Connection "";
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

# Pass authentication headers to backend services
# SECURITY: These headers MUST be set by Lua auth handlers (ngx.req.set_header),
# NOT read from client request ($http_*). Using nginx variables set by Lua
# ensures only gateway-validated values reach backend services.
# The Lua auth blocks call utils.clean_request_headers() to strip any
# client-supplied X-Wildbox-* headers before setting validated ones.
proxy_set_header X-Wildbox-User-ID $wildbox_user_id;
proxy_set_header X-Wildbox-Team-ID $wildbox_team_id;
proxy_set_header X-Wildbox-Plan $wildbox_plan;
proxy_set_header X-Wildbox-Role $wildbox_role;

# Remove original authorization header (already validated by gateway)
# proxy_set_header Authorization "";

# Timeout settings
proxy_connect_timeout 5s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;

# Buffer settings
proxy_buffering on;
proxy_buffer_size 4k;
proxy_buffers 8 4k;

# CORS headers for proxied responses - temporarily removed due to duplicates
# add_header 'Access-Control-Allow-Origin' '$cors_origin' always;
# add_header 'Access-Control-Allow-Credentials' '$cors_creds' always;
# add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,X-Wildbox-Request-ID' always;

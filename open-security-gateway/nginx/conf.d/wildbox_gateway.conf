# Wildbox Security Gateway - Main Configuration
# Handles routing, authentication, and load balancing for all Wildbox services

# Upstream definitions for all Wildbox microservices
# Using resolver to handle dynamic service discovery
resolver 127.0.0.11 valid=30s;

upstream identity_service {
    server open-security-identity:8001 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8001 backup down;
    keepalive 32;
}

upstream data_service {
    server open-security-data:8002 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8002 backup down;
    keepalive 32;
}

# upstream cspm_service {
#     server open-security-cspm:8019 max_fails=3 fail_timeout=30s;
#     server 127.0.0.1:8019 backup down;
#     keepalive 32;
# }

upstream guardian_service {
    server open-security-guardian:8013 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8013 backup down;
    keepalive 32;
}

upstream responder_service {
    server open-security-responder:8018 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8018 backup down;
    keepalive 32;
}

upstream agents_service {
    server open-security-agents:8006 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8006 backup down;
    keepalive 32;
}

upstream api_service {
    server open-security-tools:8000 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8000 backup down;
    keepalive 32;
}

upstream dashboard_service {
    server open-security-dashboard:3000 max_fails=3 fail_timeout=30s;
    server dashboard:3000 backup;
    server host.docker.internal:3000 backup;
    keepalive 32;
}

# ============================================================================
# EXCLUDED FROM v1.0 - ROADMAP FUTURE  
# ============================================================================
# upstream sensor_service {
#     server open-security-sensor:8004 max_fails=3 fail_timeout=30s;
#     server 127.0.0.1:8004 backup down;
#     keepalive 32;
# }

upstream automations_service {
    server 127.0.0.1:5678 down;
    keepalive 32;
}

# HTTP to HTTPS redirect (Production security requirement)
# All traffic except health checks MUST use HTTPS
server {
    listen 80;
    server_name api.wildbox.local wildbox.local *.wildbox.local;

    # Health check endpoint (allow HTTP for load balancer checks)
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"wildbox-gateway","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }

    # SECURITY: Force HTTPS for all other requests
    # This prevents authentication bypass via unencrypted HTTP
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# LEGACY HTTP SERVER â€” SECURITY HARDENED
# Previously this block exposed ALL API endpoints over unencrypted HTTP
# with inconsistent authentication, allowing auth bypass on multiple routes.
# Now all requests on port 8080 are rejected with a redirect to HTTPS.
server {
    listen 8080;
    server_name api.wildbox.local wildbox.local *.wildbox.local;

    # Health check (keep for load balancer probes over internal network)
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"wildbox-gateway","port":"8080-redirect-only"}';
        add_header Content-Type application/json;
    }

    # Reject ALL other requests â€” force HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# --- LEGACY HTTP/8080 ROUTES REMOVED (Security Fix) ---
# The original ~570 lines of HTTP/8080 location blocks have been removed.
# They exposed API endpoints with inconsistent authentication compared
# to the HTTPS/443 server block, enabling complete auth bypass.
# The full original content is preserved in git history.
# If you need to restore specific routes, add them to the HTTPS/443
# server block below with proper access_by_lua_file authentication.

# Main HTTPS server block
server {
    listen 443 ssl;
    http2 on;
    server_name api.wildbox.local wildbox.local *.wildbox.local;

    # Include CORS configuration
    include /etc/nginx/conf.d/cors_params.conf;

    # SSL Configuration
    ssl_certificate /etc/ssl/wildbox/wildbox.crt;
    ssl_certificate_key /etc/ssl/wildbox/wildbox.key;
    
    # SSL Security Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;

    # Enhanced Security Headers (Blueprint Phase 1 - Gateway Hardening)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https: wss:; font-src 'self' data:; object-src 'none'; media-src 'self'; frame-src 'none';" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), interest-cohort=()" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    
    # Remove server identification
    more_clear_headers Server;
    server_tokens off;

    # HTTP Method Restrictions (Blueprint Phase 1 Requirement)
    if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|PATCH)$ ) {
        return 405 '{"error":"method_not_allowed","message":"HTTP method not supported","allowed":["GET","HEAD","POST","PUT","DELETE","PATCH"]}';
    }

    # Global rate limiting (temporarily disabled pending infrastructure fixes)
    # PENDING: Data service PostgreSQL auth failure blocks gateway restart
    # limit_req zone=global burst=10 nodelay;
    # limit_req_status 429;

    # Variables for dynamic routing (initialized by Lua)
    set $wildbox_user_id "";
    set $wildbox_team_id "";
    set $wildbox_plan "";
    set $wildbox_role "";
    set $gateway_debug "false";

    # Health check endpoint (no auth required)
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"wildbox-gateway","timestamp":"$time_iso8601","ssl":"enabled"}';
        add_header Content-Type application/json;
    }

    # CORS preflight handler for all API routes (temporarily disabled)
    # location ~ ^/api.*$ {
    #     if ($request_method = 'OPTIONS') {
    #         add_header 'Access-Control-Allow-Origin' '$cors_origin' always;
    #         add_header 'Access-Control-Allow-Credentials' '$cors_creds' always;
    #         add_header 'Access-Control-Allow-Methods' '$cors_methods' always;
    #         add_header 'Access-Control-Allow-Headers' '$cors_headers' always;
    #         add_header 'Access-Control-Max-Age' 1728000 always;
    #         add_header 'Content-Type' 'text/plain; charset=utf-8' always;
    #         add_header 'Content-Length' 0 always;
    #         return 204;
    #     }
    #     
    #     # This location is a fallback - specific API routes are handled below
    #     return 404 '{"error":"endpoint_not_found","message":"The requested API endpoint does not exist"}';
    #     add_header Content-Type application/json;
    # }

    # Public endpoints (no authentication required)
    location /public/ {
        # Serve static content or documentation
        alias /var/www/public/;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # Dashboard authentication pages (no auth required) - must come before API endpoints
    location = /auth/login {
        # Exact match for login page
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    location = /auth/signup {
        # Exact match for signup page
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    location = /auth/logout {
        # Exact match for logout page
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # User endpoints (identity service, requires auth) - use ^~ for precedence over regex
    location ^~ /auth/users/ {
        # Proxy to identity service with correct API path  
        proxy_pass http://identity_service/api/v1/users/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # Authentication API endpoints (identity service, no gateway auth) - use ^~ for precedence
    location ^~ /auth/jwt/ {
        # Rate limiting for auth endpoints (brute-force protection)
        limit_req zone=auth burst=3 nodelay;
        limit_req_status 429;

        # Proxy to identity service with correct API path
        proxy_pass http://identity_service/api/v1/auth/jwt/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Registration API endpoint (identity service, no gateway auth) - use ^~ for precedence
    location ^~ /auth/register {
        limit_req zone=auth burst=2 nodelay;
        limit_req_status 429;

        # Proxy to identity service with correct API path
        proxy_pass http://identity_service/api/v1/auth/register;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Forgot password API endpoint (identity service, no gateway auth) - use ^~ for precedence
    location ^~ /auth/forgot-password {
        limit_req zone=auth burst=2 nodelay;
        limit_req_status 429;

        # Proxy to identity service with correct API path
        proxy_pass http://identity_service/api/v1/auth/forgot-password;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # Reset password API endpoint (identity service, no gateway auth) - use ^~ for precedence
    location ^~ /auth/reset-password {
        # Proxy to identity service with correct API path
        proxy_pass http://identity_service/api/v1/auth/reset-password;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Public authentication pages (no auth required) - catch remaining auth pages
    location ~ ^/(login|register|signup)/ {
        # No authentication required for auth pages (but not API endpoints)
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # Static assets (no auth required)
    location ~ ^/(_next|favicon\.ico|.*\.(css|js|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot|ico))$ {
        # No authentication required for static assets
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
        
        # Cache static assets
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Dashboard (web interface) - requires auth
    location / {
        # Authentication required (includes rate limiting)
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        # Proxy to dashboard
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # API Routes - All require authentication

    # Identity Service API - Authentication endpoints (no auth required)
    location /api/v1/identity/auth/ {
        # No authentication required for auth endpoints
        proxy_pass http://identity_service/api/v1/auth/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # Identity Service API - Other endpoints (auth required)
    location /api/v1/identity/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://identity_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Data Service API - OLD BLOCK (replaced by inline Lua pattern above)
    # location /api/v1/data/ {
    #     # Authentication required (includes feature gating)
    #     access_by_lua_file /etc/nginx/lua/auth_handler.lua;
    #
    #     proxy_pass http://data_service/api/v1/;
    #     include /etc/nginx/conf.d/proxy_params.conf;
    #
    #     # Cache data responses (temporarily disabled)
    #     # proxy_cache wildbox_cache;
    #     # proxy_cache_key "$scheme$request_method$host$request_uri$wildbox_team_id$wildbox_plan";
    #     # proxy_cache_valid 200 5m;
    #     # proxy_cache_valid 404 1m;
    # }

    # CSPM Service API
    # location /api/v1/cspm/ {
    #     # Authentication required (includes plan validation)
    #     access_by_lua_file /etc/nginx/lua/auth_handler.lua;
    #     
    #     proxy_pass http://cspm_service/api/v1/;
    #     include /etc/nginx/conf.d/proxy_params.conf;
    # }

    # Guardian Service API - OLD BLOCK (replaced by inline Lua pattern below)
    # location /api/v1/guardian/ {
    #     access_by_lua_file /etc/nginx/lua/auth_handler.lua;
    #     
    #     proxy_pass http://guardian_service/api/v1/;
    #     include /etc/nginx/conf.d/proxy_params.conf;
    # }

    # Agents Service API - AI-powered threat intelligence
    # Transforms /api/v1/agents/* to /v1/* on backend (Agents uses /v1/analyze path)
    location ~ ^/api/v1/agents/(.*)$ {
        # Authentication required - inline Lua for regex location compatibility
        access_by_lua_block {
            ngx.log(ngx.ERR, "ðŸ” AGENTS API: Lua auth handler called for path: " .. ngx.var.uri)
            
            -- Extract API key from header
            local api_key = ngx.req.get_headers()["X-API-Key"]
            
            if not api_key or api_key == "" then
                ngx.log(ngx.ERR, "âŒ AGENTS API: No API key provided")
                ngx.status = 401
                ngx.header.content_type = "application/json"
                ngx.say('{"error":"unauthorized","message":"API key required","code":"NO_API_KEY"}')
                return ngx.exit(401)
            end
            
            ngx.log(ngx.ERR, "ðŸ”‘ AGENTS API: Validating API key with identity service")
            
            -- Call identity service to validate
            local http = require "resty.http"
            local cjson = require "cjson"
            local httpc = http.new()
            httpc:set_timeout(5000)
            
            local res, err = httpc:request_uri("http://identity:8001/internal/authorize", {
                method = "POST",
                body = cjson.encode({
                    token = api_key,
                    token_type = "api_key"
                }),
                headers = {
                    ["Content-Type"] = "application/json",
                }
            })
            
            if not res then
                ngx.log(ngx.ERR, "âŒ AGENTS API: Failed to contact identity service: " .. (err or "unknown"))
                ngx.status = 503
                ngx.header.content_type = "application/json"
                ngx.say('{"error":"service_unavailable","message":"Authentication service unavailable"}')
                return ngx.exit(503)
            end
            
            if res.status ~= 200 then
                ngx.log(ngx.ERR, "âŒ AGENTS API: Identity service rejected token (status: " .. res.status .. ")")
                ngx.status = 401
                ngx.header.content_type = "application/json"
                ngx.say('{"error":"unauthorized","message":"Invalid API key","code":"INVALID_API_KEY"}')
                return ngx.exit(401)
            end
            
            -- Parse response
            local auth_data = cjson.decode(res.body)
            
            if not auth_data.user_id or not auth_data.team_id then
                ngx.log(ngx.ERR, "âŒ AGENTS API: Missing user/team ID in auth response")
                ngx.status = 401
                ngx.header.content_type = "application/json"
                ngx.say('{"error":"unauthorized","message":"Invalid authentication data"}')
                return ngx.exit(401)
            end
            
            ngx.log(ngx.ERR, "âœ… AGENTS API: Authentication successful for user: " .. auth_data.user_id)
            
            -- SECURITY: Strip ALL client-supplied auth headers to prevent spoofing
            ngx.req.clear_header("X-Wildbox-User-ID")
            ngx.req.clear_header("X-Wildbox-Team-ID")
            ngx.req.clear_header("X-Wildbox-Plan")
            ngx.req.clear_header("X-Wildbox-Role")
            ngx.req.clear_header("Authorization")
            ngx.req.clear_header("X-API-Key")

            -- Set headers from validated auth data only
            ngx.req.set_header("X-Wildbox-User-ID", auth_data.user_id)
            ngx.req.set_header("X-Wildbox-Team-ID", auth_data.team_id)
            ngx.req.set_header("X-Wildbox-Plan", auth_data.plan or "free")
            ngx.req.set_header("X-Wildbox-Role", auth_data.role or "member")
        }
        
        # Transform path: /api/v1/agents/* -> /v1/*
        proxy_pass http://agents_service/v1/$1$is_args$args;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Security Tools API v1 (available to all authenticated users)
    # Transforms /api/v1/tools/* to /api/tools/* on the backend
    location ~ ^/api/v1/tools/(.*)$ {
        # Rate Limiting - DISABLED: investigating "zero size zone" error
        # limit_req zone=global burst=10 nodelay;
        # limit_req_status 429;
        
        # Authentication required - using inline block for regex location
        access_by_lua_block {
            ngx.log(ngx.ERR, "ðŸ” TOOLS API: Lua auth handler called for path: " .. ngx.var.uri)
            local auth_handler = require "auth_handler"
            auth_handler.authenticate()
            ngx.log(ngx.ERR, "âœ… TOOLS API: Auth handler completed successfully")
        }
        
        # Transform path: /api/v1/tools/* -> /api/tools/*
        proxy_pass http://api_service/api/tools/$1$is_args$args;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Security Tools API (available to all authenticated users)
    location /api/tools/ {
        # Authentication required
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://api_service/api/tools/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # Security Tools Web Interface (available to all authenticated users)
    location /tools/ {
        # Authentication required
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://api_service/tools/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ============================================================================
    # EXCLUDED FROM v1.0 - ROADMAP FUTURE
    # ============================================================================
    # Sensor Service API
    # location /api/v1/sensor/ {
    #     access_by_lua_file /etc/nginx/lua/auth_handler.lua;
    #     
    #     proxy_pass http://sensor_service/api/v1/;
    #     include /etc/nginx/conf.d/proxy_params.conf;
    # }

    # Automations Service API (Business plan and higher)
    location /api/v1/automations/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        # Feature gating: Automations requires business plan or higher
        
        proxy_pass http://automations_service/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # WebSocket endpoints for real-time features
    location /ws/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
        
        # Override for WebSocket
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
    }

    # Catch-all for undefined routes
    location ~ ^/api/ {
        return 404 '{"error":"endpoint_not_found","message":"The requested API endpoint does not exist"}';
        add_header Content-Type application/json;
    }
}

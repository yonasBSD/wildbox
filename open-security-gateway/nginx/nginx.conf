# OpenResty/Nginx Configuration for Wildbox Security Gateway
# Performance-optimized for high-throughput API traffic

# user nginx;  # Commented out for Alpine OpenResty (no nginx user)
worker_processes auto;
worker_rlimit_nofile 65535;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # Add custom Lua module path
    lua_package_path "/etc/nginx/lua/?.lua;;";
    
    include       mime.types;
    default_type application/octet-stream;

    # Logging Configuration
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # Enhanced log format for API gateway
    log_format gateway '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      'rt=$request_time uct="$upstream_connect_time" '
                      'uht="$upstream_header_time" urt="$upstream_response_time" '
                      'team_id="$sent_http_x_wildbox_team_id" '
                      'user_id="$sent_http_x_wildbox_user_id" '
                      'plan="$sent_http_x_wildbox_plan"';

    access_log /var/log/nginx/access.log gateway;

    # Performance Settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;

    # Buffer Settings for High Traffic
    client_body_buffer_size 128k;
    client_max_body_size 50m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    output_buffers 1 32k;
    postpone_output 1460;

    # Proxy Settings
    proxy_buffer_size 4k;
    proxy_buffers 16 4k;
    proxy_busy_buffers_size 8k;
    proxy_temp_file_write_size 8k;
    proxy_connect_timeout 30s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml
        text/css
        text/javascript
        text/xml
        text/plain;

    # Rate Limiting Zones
    # Basic rate limiting - team-based limiting will be handled by Lua
    limit_req_zone $binary_remote_addr zone=global:10m rate=100r/s;
    limit_req_zone $binary_remote_addr zone=per_ip:10m rate=50r/s;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;

    # Connection Limiting
    limit_conn_zone $binary_remote_addr zone=addr:10m;

        # Shared memory zones for rate limiting and caching
    lua_shared_dict auth_cache 10m;           # JWT/API key validation cache
    lua_shared_dict rate_limit_cache 10m;     # Rate limiting counters
    lua_shared_dict config_cache 1m;          # Gateway configuration cache

    # CORS Maps (must be in http context)
    map $request_method $cors_origin {
        default "";
        OPTIONS $http_origin;
        GET $http_origin;
        POST $http_origin;
        PUT $http_origin;
        DELETE $http_origin;
        PATCH $http_origin;
    }

    map $request_method $cors_creds {
        default "";
        OPTIONS "true";
        GET "true";
        POST "true";
        PUT "true";
        DELETE "true";
        PATCH "true";
    }

    map $request_method $cors_methods {
        default "";
        OPTIONS "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        GET "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        POST "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        PUT "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        DELETE "GET, POST, PUT, DELETE, PATCH, OPTIONS";
        PATCH "GET, POST, PUT, DELETE, PATCH, OPTIONS";
    }

    map $request_method $cors_headers {
        default "";
        OPTIONS "Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With,X-Wildbox-Team-ID,X-Wildbox-Plan,X-API-Key";
        GET "Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With,X-Wildbox-Team-ID,X-Wildbox-Plan,X-API-Key";
        POST "Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With,X-Wildbox-Team-ID,X-Wildbox-Plan,X-API-Key";
        PUT "Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With,X-Wildbox-Team-ID,X-Wildbox-Plan,X-API-Key";
        DELETE "Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With,X-Wildbox-Team-ID,X-Wildbox-Plan,X-API-Key";
        PATCH "Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With,X-Wildbox-Team-ID,X-Wildbox-Plan,X-API-Key";
    }

    # Initialize Lua modules
    init_by_lua_block {
        -- Load utility functions
        require "utils"
        require "auth_handler"
        
        -- Global configuration
        local config = {
            identity_service_url = "http://open-security-identity:8000",
            auth_cache_ttl = 300, -- 5 minutes
            rate_limit_window = 3600, -- 1 hour
            log_level = os.getenv("GATEWAY_LOG_LEVEL") or "info"
        }
        
        -- Store config in shared dict
        local config_cache = ngx.shared.config_cache
        config_cache:set("gateway_config", require("cjson").encode(config))
        
        ngx.log(ngx.INFO, "Wildbox Security Gateway initialized")
    }

    # Proxy Cache Configuration
    proxy_cache_path /var/cache/nginx/wildbox_cache levels=1:2 keys_zone=wildbox_cache:100m 
                     max_size=1g inactive=60m use_temp_path=off;

    # Include service-specific configurations
    include /etc/nginx/conf.d/*.conf;
}
